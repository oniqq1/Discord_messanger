{% extends "base.html" %}

{% block head %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', path='index.css') }}">
{% endblock %}

{% block title %}ChatSpace –ß–∞—Ç{% endblock %}

{% block content %}
    <main class="chat-page">
        <div class="server-list">
            <div class="server-item" id="addRoomBtn">
                <span>+</span>
            </div>
        </div>

        <div id="roomModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close" id="closeModal">&times;</span>
                <h2>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</h2>
                <input type="text" id="roomInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã">
                <button id="joinRoomBtn" class="btn btn-primary btn-full">–í–æ–π—Ç–∏</button>
            </div>
        </div>

        <div class="chat-main">
            <div class="chat-messages" id="chatMessages">
                <div class="message">
                    <div class="message-avatar">A</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="username">Admin</span>
                            <span class="timestamp">–°–µ–≥–æ–¥–Ω—è</span>
                        </div>
                        <div class="message-text">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ChatSpace! üéâ</div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input">
                <div class="input-container">
                    <input type="text" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
                    <button id="sendButton">üì§</button>
                    <button id="disconnectButton" style="margin-left:8px;">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
                </div>
            </div>
        </div>
    </main>

    <script src="../static/index.js"></script>
    <script>
        let ws = null;
        let connected = false;
        let currentRoom = null;
        let firstConnect = true;

        document.getElementById('addRoomBtn').onclick = function() {
            document.getElementById('roomModal').style.display = 'block';
            document.getElementById('roomInput').focus();
        };
        document.getElementById('closeModal').onclick = function() {
            document.getElementById('roomModal').style.display = 'none';
        };
        document.getElementById('roomModal').onclick = function(e) {
            if (e.target === this) this.style.display = 'none';
        };
        document.getElementById('joinRoomBtn').onclick = function() {
            const room = document.getElementById('roomInput').value.trim();
            if (room) {
                joinRoom(room);
                document.getElementById('roomModal').style.display = 'none';
            }
        };
        document.getElementById('roomInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') document.getElementById('joinRoomBtn').click();
        });

        function joinRoom(room) {
            if (ws) {
                ws.onclose = null;
                ws.close();
            }
            connected = false;
            currentRoom = room;
            ws = new WebSocket(`ws://127.0.0.1:8000/ws/${room}`);
            ws.onopen = () => {
                connected = true;
                if (!firstConnect) {
                    appendSystem(`–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ: ${room}`);
                }
                firstConnect = false;
            };
            ws.onmessage = (e) => appendMessage(e.data);
            ws.onclose = () => {
                if (connected) {
                    appendSystem("–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
                }
                connected = false;
            };
        }

        document.getElementById('sendButton').onclick = sendMessage;
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        document.getElementById('disconnectButton').onclick = disconnectRoom;

        function disconnectRoom() {
            if (ws && connected) {
                ws.onclose = null;
                ws.close();
                appendSystem("–í—ã –æ—Ç–∫–ª—é—á–∏–ª–∏—Å—å –æ—Ç –∫–æ–º–Ω–∞—Ç—ã");
                connected = false;
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            if (!currentRoom || !ws || ws.readyState !== WebSocket.OPEN || !connected) {
                appendSystem("–í—ã –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –∫–æ–º–Ω–∞—Ç–µ!");
                return;
            }
            if (input.value.trim()) {
                ws.send(input.value);
                input.value = '';
            }
        }

        function appendMessage(text) {
            const chat = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            msgDiv.innerHTML = `
                <div class="message-avatar">U</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="username">User</span>
                        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-text">${text}</div>
                </div>
            `;
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
        }

        function appendSystem(text) {
            const chat = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            msgDiv.innerHTML = `
                <div class="message-avatar">S</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="username" style="color:gray;">System</span>
                        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="message-text" style="color:gray;">${text}</div>
                </div>
            `;
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
        }
    </script>
{% endblock %}